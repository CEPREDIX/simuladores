<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Clases Grabadas</title>
    
    <!-- Librer√≠as de Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Librer√≠as del Calendario y Datos -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/locales/es.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        /* Estilos Base del Tema (C√≥digo B) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-image: url('https://i.imgur.com/7ndIyWP.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            padding: 15px;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            min-height: 100vh;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); z-index: -1;
        }
        .container-custom {
            width: 100%; max-width: 1200px; margin: 0 auto;
            display: flex; flex-direction: column;            
        }
        .header {
            text-align: center; padding: 15px; border-radius: 15px; margin-bottom: 20px;
            background: linear-gradient(45deg, #0d47a1, #00695c, #ff6f00, #b71c1c, #4a148c);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .logo {
            width: 100px; height: 100px; margin: 0 auto 10px;
            background: url('https://i.imgur.com/I1unSiu.png') center/contain no-repeat;
        }
        .card {
            background: rgba(25, 25, 35, 0.85); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            width: 100%; margin-bottom: 20px; position: relative;
        }
        .btn {
            padding: 10px 20px; font-size: 1.1rem; border: none; border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(45deg, #2196F3, #21CBF3); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #f44336, #ff9800); color: white; }
        .btn-success { background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; }
        
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        .btn:active:not(:disabled) { transform: translateY(1px); }

        /* --- Personalizaci√≥n de FullCalendar para Modo Oscuro --- */
        #calendar {
            max-width: 100%;
            margin: 0 auto;
            font-family: 'Roboto', sans-serif;
        }
        
        .fc-theme-standard .fc-scrollgrid {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .fc th {
            border-color: rgba(255, 255, 255, 0.1);
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px 0;
            color: #4fc3f7;
        }
        .fc td {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .fc .fc-daygrid-day-number {
            color: #fff;
            text-decoration: none;
        }
        .fc .fc-col-header-cell-cushion {
            color: #4fc3f7;
            text-decoration: none;
        }
        .fc-day-today {
            background-color: rgba(33, 150, 243, 0.15) !important;
        }
        /* Botones del Toolbar de FullCalendar */
        .fc .fc-button-primary {
            background: rgba(50, 50, 70, 0.8);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            text-transform: capitalize;
        }
        .fc .fc-button-primary:hover {
            background: rgba(70, 70, 90, 0.9);
            border-color: #4fc3f7;
        }
        .fc .fc-button-primary:not(:disabled).fc-button-active, 
        .fc .fc-button-primary:not(:disabled):active {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            border-color: transparent;
        }
        .fc-toolbar-title {
            color: white;
            font-size: 1.5rem !important;
            font-weight: 700;
        }
        
        /* Eventos del Calendario */
        .fc-event {
            cursor: pointer;
            border: none !important;
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-radius: 4px;
            padding: 2px 4px;
            transition: transform 0.2s;
        }
        .fc-event:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #ab47bc, #7e57c2);
        }
        .fc-event-title {
            font-weight: 500;
            color: white;
        }

        /* Modal personalizado */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: rgba(30, 30, 40, 0.95);
            border: 1px solid #4fc3f7;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            position: relative;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.3);
            animation: modalFadeIn 0.3s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: #aaa;
            font-size: 1.5rem; cursor: pointer;
        }
        .modal-close:hover { color: #fff; }

        @media (max-width: 768px) {
            .fc-toolbar { flex-direction: column; gap: 10px; }
            .fc-toolbar-title { font-size: 1.2rem !important; }
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div class="container-custom">
        <!-- Header con animaci√≥n -->
        <header class="header">
            <div class="logo"></div>
            <h1 class="text-2xl sm:text-3xl font-bold">CALENDARIO DE CLASES GRABADAS</h1>
            <h2 class="text-xl sm:text-2xl">Plataforma CEPREDIX</h2>
            <p class="text-sm sm:text-base">Accede a las grabaciones organizadas por fecha</p>
        </header>

        <!-- Pantalla de Login (Basada en C√≥digo B) -->
        <div id="login-screen" class="card p-6 sm:p-8 space-y-6 max-w-2xl mx-auto">
            <div class="text-center">
                <h2 class="text-2xl sm:text-3xl font-bold">Bienvenido</h2>
                <p class="text-gray-300 mt-2">Por favor, valida tus datos para acceder al calendario.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="name-input" class="font-medium text-gray-200">Nombre y apellido</label>
                    <input type="text" id="name-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white focus:border-blue-400 focus:outline-none" placeholder="Tu nombre completo" required>
                </div>
                <div>
                    <label for="email-input" class="font-medium text-gray-200">Correo Electr√≥nico</label>
                    <input type="email" id="email-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white focus:border-blue-400 focus:outline-none" placeholder="tu.correo@ejemplo.com" required>
                </div>
                <div>
                    <label for="whatsapp-input" class="font-medium text-gray-200">WhatsApp (10 d√≠gitos)</label>
                    <input type="password" id="whatsapp-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white focus:border-blue-400 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10" inputmode="numeric" required>
                </div>
                <button id="login-btn" type="submit" class="btn btn-primary w-full text-lg shadow-lg">
                    <span id="login-btn-text">Verificar y Entrar</span>
                    <span id="login-btn-spinner" class="hidden animate-spin ml-2"><i class="fas fa-spinner"></i></span>
                </button>
            </form>
            
            <div class="space-y-2 border-t border-gray-600 pt-4">
                <!-- Bot√≥n de Invitado MODIFICADO: Redirige a enlace externo -->
                <button id="guest-login-btn" class="btn btn-secondary w-full">ACCEDER COMO INVITADO</button>
                <p class="text-xs text-center text-gray-400">El acceso como invitado est√° restringido. Si no tienes cuenta, contacta al administrador.</p>
            </div>
            
            <a href="https://wa.link/i5rp89" target="_blank" class="btn btn-secondary w-full !mt-2">NO TENGO ACCESO üò•</a>
            <p id="login-error-message" class="text-red-400 text-center text-sm font-bold min-h-[20px]"></p>
        </div>

        <!-- Pantalla del Calendario (Oculta inicialmente) -->
        <div id="calendar-screen" class="card hidden">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-blue-400">Hola, <span id="user-name-display" class="text-white">Estudiante</span></h2>
                    <p class="text-gray-400 text-sm">Selecciona una clase para ver el tema y el enlace.</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button id="refreshBtn" class="btn btn-success text-sm py-2">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <button id="helpBtn" class="btn btn-secondary text-sm py-2">
                        <i class="fas fa-question-circle"></i> Ayuda
                    </button>
                </div>
            </div>

            <!-- Contenedor del Calendario -->
            <div id="calendar"></div>
            
            <div id="loading" class="text-center py-10 text-blue-400">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p class="mt-4">Cargando datos de las clases...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles del Evento -->
    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" id="closeModal">&times;</button>
            <h3 id="modalTitle" class="text-xl font-bold text-blue-400 mb-2 border-b border-gray-600 pb-2"></h3>
            <div class="space-y-3 text-gray-200">
                <p><strong class="text-gray-400"><i class="far fa-calendar mr-2"></i>Fecha:</strong> <span id="modalDate"></span></p>
                <div>
                    <strong class="text-gray-400 block mb-1"><i class="fas fa-book mr-2"></i>Temas abordados:</strong>
                    <p id="modalTopics" class="bg-gray-800 p-3 rounded text-sm border border-gray-700"></p>
                </div>
                <a href="#" id="modalLink" target="_blank" class="btn btn-primary w-full mt-4 text-center block">
                    <i class="fas fa-video mr-2"></i> Ver Clase Grabada
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONSTANTES ---
            const AUTH_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5sU2hYNByYHNDESXxZPoe3dikV115hY_TII15wZtF8E0NWBFmnLSW2ad7ZqDdwk-jTPQfX-92n6zQ/pub?gid=0&single=true&output=csv';
            const RESULTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYESY3dBy0h5QrY5EyJ_jfHwlEwnhByFcPTywwK4jJhGa3rvrnIzR9OXleZUZ7zVqUqw/exec';
            // Proxy CORS para Auth (como en C√≥digo B)
            const CORS_PROXY_URL = `https://corsproxy.io/?${encodeURIComponent(AUTH_SHEET_URL)}`;
            
            // Hoja de Clases (C√≥digo A) - Se usa directo porque pub csv suele permitir GET simple
            const CALENDAR_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSh4t56iMdtNqrEW-qLggn2ST-f5KIGA2On37j6tbwaClae9Zu5ElxeKL5lO0dN2omlc5FEd2LWC6Yh/pub?gid=0&single=true&output=csv';

            // --- ELEMENTOS DOM ---
            const loginScreen = document.getElementById('login-screen');
            const calendarScreen = document.getElementById('calendar-screen');
            const loginForm = document.getElementById('login-form');
            const loginBtn = document.getElementById('login-btn');
            const loginBtnText = document.getElementById('login-btn-text');
            const loginBtnSpinner = document.getElementById('login-btn-spinner');
            const loginError = document.getElementById('login-error-message');
            const guestBtn = document.getElementById('guest-login-btn');
            const userNameDisplay = document.getElementById('user-name-display');
            
            const calendarEl = document.getElementById('calendar');
            const loadingEl = document.getElementById('loading');
            const refreshBtn = document.getElementById('refreshBtn');
            const helpBtn = document.getElementById('helpBtn');
            
            // Modal Elements
            const eventModal = document.getElementById('eventModal');
            const closeModal = document.getElementById('closeModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDate = document.getElementById('modalDate');
            const modalTopics = document.getElementById('modalTopics');
            const modalLink = document.getElementById('modalLink');

            let calendarInstance = null;

            // --- L√ìGICA DE AUTENTICACI√ìN ---

           // --- L√ìGICA DE AUTENTICACI√ìN MEJORADA (COPIADA DE REFERENCIA) ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // 1. Obtener y limpiar datos (Igual que en el c√≥digo de referencia)
                const name = document.getElementById('name-input').value.trim();
                const emailRaw = document.getElementById('email-input').value.trim();
                const whatsappRaw = document.getElementById('whatsapp-input').value.trim();

                // Limpieza estricta: Correo a min√∫sculas, WhatsApp solo n√∫meros
                const email = emailRaw.toLowerCase();
                const whatsapp = whatsappRaw.replace(/\D/g, ''); // Quita espacios o guiones

                // UI: Mostrar carga
                loginError.textContent = '';
                loginBtn.disabled = true;
                loginBtnText.classList.add('hidden');
                loginBtnSpinner.classList.remove('hidden');

                try {
                    // 2. Truco Anti-Cach√©: Agregar timestamp para forzar datos nuevos
                    const timestamp = new Date().getTime();
                    // Usamos la misma hoja de AUTH pero forzamos recarga
                    const freshSheetUrl = AUTH_SHEET_URL + '&v=' + timestamp;
                    const freshProxyUrl = `https://corsproxy.io/?${encodeURIComponent(freshSheetUrl)}`;

                    const response = await fetch(freshProxyUrl);
                    if (!response.ok) throw new Error('Error al conectar con la base de datos.');
                    
                    const csvData = await response.text();
                    const rows = csvData.split('\n').map(row => row.split(',').map(c => c.trim()));
                    
                    let userFound = false;
                    let isInactive = false;

                    // 3. Buscar usuario en el CSV (Columnas: 1=Email, 2=Whatsapp, 6=Estado)
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (cols.length < 3) continue;

                        const rowEmail = cols[1] ? cols[1].toLowerCase() : "";
                        const rowWhatsapp = cols[2] ? cols[2].replace(/\D/g, '') : "";
                        
                        if (rowEmail === email && rowWhatsapp === whatsapp) {
                            userFound = true;
                            // Verificar si est√° ACTIVO o INACTIVO (Columna 6 aprox en tu referencia)
                            const status = cols[6] ? cols[6].toUpperCase().replace(/[^A-Z]/g, '') : 'ACTIVO';
                            if (status === 'INACTIVO') {
                                isInactive = true;
                            }
                            break;
                        }
                    }

                    if (isInactive) {
                        loginError.style.color = "#ff5722";
                        loginError.textContent = 'Tu cuenta aparece como INACTIVA. Contacta al administrador.';
                        throw new Error('Usuario inactivo');
                    }

                    if (userFound) {
                        // 4. Validaci√≥n extra con el Servidor (POST al Script) para asegurar
                        const formData = new FormData();
                        formData.append('action', 'login');
                        formData.append('email', email);
                        formData.append('whatsapp', whatsapp);

                        // Intentamos validar con el script oficial tambi√©n
                        try {
                            await fetch(RESULTS_SCRIPT_URL, {
                                method: 'POST',
                                body: formData,
                                redirect: 'follow'
                            });
                            // Si el fetch funciona, asumimos √©xito (el CSV ya confirm√≥ los datos)
                        } catch (errScript) {
                            console.log("Advertencia: El script secundario no respondi√≥, pero el CSV valid√≥ ok.");
                        }

                        // ¬°√âXITO!
                        userNameDisplay.textContent = name;
                        showCalendar();
                    } else {
                        loginError.style.color = "#f87171";
                        loginError.textContent = 'Datos incorrectos. Verifica tu correo y WhatsApp (sin espacios).';
                    }

                } catch (error) {
                    console.error(error);
                    if (error.message !== 'Usuario inactivo') {
                        loginError.textContent = 'Error de conexi√≥n o datos no encontrados.';
                    }
                } finally {
                    // Restaurar bot√≥n
                    loginBtn.disabled = false;
                    loginBtnText.classList.remove('hidden');
                    loginBtnSpinner.classList.add('hidden');
                }
            });

            // --- L√ìGICA DE BOT√ìN INVITADO (Restricci√≥n) ---
            guestBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Redirigir al enlace de "No tengo acceso"
                window.location.href = 'https://wa.link/i5rp89';
            });

            // --- L√ìGICA DEL CALENDARIO ---

            function showCalendar() {
                loginScreen.classList.add('hidden');
                calendarScreen.classList.remove('hidden');
                initCalendar();
            }

            function initCalendar() {
                calendarInstance = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    themeSystem: 'standard',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listMonth'
                    },
                    buttonText: {
                        today: 'Hoy',
                        month: 'Mes',
                        list: 'Lista'
                    },
                    height: 'auto',
                    eventClick: function(info) {
                        openModal(info.event);
                    },
                    events: [] // Se cargar√°n v√≠a PapaParse
                });

                calendarInstance.render();
                loadEvents();
            }

            function loadEvents() {
                loadingEl.style.display = 'block';
                if(calendarInstance) calendarInstance.removeAllEvents();

                Papa.parse(CALENDAR_SHEET_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const events = [];
                        
                        if (results.data && results.data.length > 0) {
                            results.data.forEach(row => {
                                // Validar datos m√≠nimos
                                if (row.Fecha && row.Clase && row['Temas abordados'] && row.Enlace) {
                                    // Parsear fecha DD/MM/YYYY a YYYY-MM-DD
                                    const parts = row.Fecha.split('/');
                                    if (parts.length === 3) {
                                        const isoDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                                        
                                        events.push({
                                            title: row.Clase,
                                            start: isoDate,
                                            extendedProps: {
                                                topics: row['Temas abordados'],
                                                link: row.Enlace
                                            }
                                        });
                                    }
                                }
                            });
                        }

                        if (calendarInstance) {
                            calendarInstance.addEventSource(events);
                        }
                        loadingEl.style.display = 'none';
                    },
                    error: function(err) {
                        console.error('Error parsing CSV:', err);
                        loadingEl.innerHTML = '<p class="text-red-400">Error al cargar los datos.</p>';
                    }
                });
            }

            // --- L√ìGICA DEL MODAL ---
            function openModal(event) {
                modalTitle.textContent = event.title;
                
                // Formatear fecha para mostrar
                const dateObj = event.start;
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                modalDate.textContent = dateObj.toLocaleDateString('es-ES', options);
                
                modalTopics.textContent = event.extendedProps.topics;
                modalLink.href = event.extendedProps.link;
                
                eventModal.style.display = 'flex';
            }

            closeModal.addEventListener('click', () => {
                eventModal.style.display = 'none';
            });

            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', (e) => {
                if (e.target == eventModal) {
                    eventModal.style.display = 'none';
                }
            });

            // Botones extra
            refreshBtn.addEventListener('click', loadEvents);
            helpBtn.addEventListener('click', () => {
                alert('Haz clic en una clase coloreada en el calendario para ver los detalles y el enlace a la grabaci√≥n.');
            });
        });
    </script>
</body>
</html>
